<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¯å‰ç«¯ PDF å‹ç¼©å·¥å…·</title>
    <!-- å¼•å…¥ Tailwind CSS ç”¨äºç¾è§‚ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ PDF å¤„ç†åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .loader {
            border-top-color: #3B82F6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4 text-slate-700">

    <div class="glass rounded-2xl p-8 max-w-lg w-full transition-all duration-300">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2 text-slate-800">PDF å‹ç¼©å·¥å…·</h1>
            <p class="text-sm text-slate-500">çº¯æœ¬åœ°å¤„ç†ï¼Œæ–‡ä»¶ä¸ä¼šä¸Šä¼ æœåŠ¡å™¨</p>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div id="dropZone" class="border-2 border-dashed border-blue-200 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors mb-6 group">
            <input type="file" id="fileInput" accept="application/pdf" class="hidden">
            <div class="text-blue-400 mb-3 group-hover:scale-110 transition-transform text-4xl">ğŸ“„</div>
            <p class="font-medium text-slate-600">ç‚¹å‡»é€‰æ‹© PDF æ–‡ä»¶</p>
            <p class="text-xs text-slate-400 mt-1">æˆ–å°†æ–‡ä»¶æ‹–æ”¾åˆ°è¿™é‡Œ</p>
        </div>

        <!-- æ–‡ä»¶ä¿¡æ¯ & é€‰é¡¹ -->
        <div id="optionsPanel" class="hidden space-y-5">
            <div class="bg-white rounded-lg p-3 text-sm flex justify-between items-center shadow-sm">
                <span id="fileName" class="truncate max-w-[200px] font-medium"></span>
                <span id="fileSize" class="text-slate-400 text-xs"></span>
            </div>

            <div>
                <div class="flex justify-between mb-2">
                    <label class="text-sm font-semibold">å‹ç¼©å¼ºåº¦ (å›¾ç‰‡è´¨é‡)</label>
                    <span id="qualityVal" class="text-sm text-blue-600 font-bold">50%</span>
                </div>
                <input type="range" id="qualityRange" min="0.1" max="0.9" step="0.1" value="0.5" 
                    class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                <p class="text-xs text-orange-500 mt-1">* æ³¨æ„ï¼šæ­¤å·¥å…·ä¼šå°†é¡µé¢è½¬ä¸ºå›¾ç‰‡ï¼Œæ–‡å­—å°†ä¸å¯å¤åˆ¶ã€‚</p>
            </div>

            <button id="compressBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 transition-all active:scale-95 flex justify-center items-center gap-2">
                <span>å¼€å§‹å‹ç¼©</span>
            </button>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div id="progressPanel" class="hidden mt-6 text-center">
            <div class="w-10 h-10 border-4 border-blue-100 rounded-full loader mx-auto mb-3"></div>
            <p id="statusText" class="text-sm font-medium animate-pulse">æ­£åœ¨å¤„ç†ç¬¬ 1 é¡µ...</p>
        </div>

        <!-- ç»“æœ -->
        <div id="resultPanel" class="hidden mt-6 text-center space-y-4">
            <div class="bg-green-50 text-green-700 p-4 rounded-xl border border-green-200">
                <p class="font-bold text-lg">ğŸ‰ å‹ç¼©å®Œæˆï¼</p>
                <p class="text-sm mt-1">æ–°æ–‡ä»¶å¤§å°: <span id="newSize" class="font-mono"></span></p>
                <p class="text-xs text-green-600 mt-1">ä½“ç§¯å‡å°‘äº† <span id="savePercent" class="font-bold"></span></p>
            </div>
            <button id="downloadBtn" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg transition-all">
                ä¸‹è½½å‹ç¼©åçš„æ–‡ä»¶
            </button>
            <button onclick="location.reload()" class="text-xs text-slate-400 underline hover:text-slate-600">å¤„ç†å¦ä¸€ä¸ªæ–‡ä»¶</button>
        </div>
    </div>

    <script>
        // è®¾ç½® PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const { jsPDF } = window.jspdf;

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const optionsPanel = document.getElementById('optionsPanel');
        const progressPanel = document.getElementById('progressPanel');
        const resultPanel = document.getElementById('resultPanel');
        const compressBtn = document.getElementById('compressBtn');
        const qualityRange = document.getElementById('qualityRange');
        const qualityVal = document.getElementById('qualityVal');
        
        let originalFile = null;
        let compressedPdfBlob = null;

        // æ‹–æ‹½äº‹ä»¶
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-400'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-blue-400'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-400');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        // è´¨é‡æ»‘å—è”åŠ¨
        qualityRange.addEventListener('input', (e) => {
            qualityVal.innerText = Math.round(e.target.value * 100) + '%';
        });

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(decimals))} ${sizes[i]}`;
        }

        function handleFile(file) {
            if (file.type !== 'application/pdf') return alert('è¯·é€‰æ‹© PDF æ–‡ä»¶');
            originalFile = file;
            
            document.getElementById('fileName').innerText = file.name;
            document.getElementById('fileSize').innerText = formatBytes(file.size);
            
            dropZone.classList.add('hidden');
            optionsPanel.classList.remove('hidden');
        }

        compressBtn.addEventListener('click', async () => {
            optionsPanel.classList.add('hidden');
            progressPanel.classList.remove('hidden');

            try {
                const arrayBuffer = await originalFile.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const totalPages = pdf.numPages;
                
                // åˆå§‹åŒ– jsPDF
                const newPdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });

                const quality = parseFloat(qualityRange.value);

                for (let i = 1; i <= totalPages; i++) {
                    document.getElementById('statusText').innerText = `æ­£åœ¨å¤„ç†ç¬¬ ${i} / ${totalPages} é¡µ...`;

                    const page = await pdf.getPage(i);
                    // 2å€ç¼©æ”¾ä»¥ä¿è¯åŸºæœ¬æ¸…æ™°åº¦ï¼Œç„¶åé€šè¿‡JPEGå‹ç¼©é™ä½ä½“ç§¯
                    const viewport = page.getViewport({ scale: 2 }); 
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    // æ ¸å¿ƒå‹ç¼©é€»è¾‘ï¼šè½¬ä¸º JPEG
                    const imgData = canvas.toDataURL('image/jpeg', quality);

                    const imgProps = newPdf.getImageProperties(imgData);
                    const pdfWidth = newPdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    if (i > 1) newPdf.addPage();
                    newPdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                }

                document.getElementById('statusText').innerText = 'æ­£åœ¨æ‰“åŒ…æ–‡ä»¶...';
                compressedPdfBlob = newPdf.output('blob');

                showResult();

            } catch (err) {
                console.error(err);
                alert('å¤„ç†å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ–‡ä»¶å·²åŠ å¯†æˆ–è¿‡å¤§ã€‚');
                location.reload();
            }
        });

        function showResult() {
            progressPanel.classList.add('hidden');
            resultPanel.classList.remove('hidden');
            
            document.getElementById('newSize').innerText = formatBytes(compressedPdfBlob.size);
            const saved = ((originalFile.size - compressedPdfBlob.size) / originalFile.size * 100).toFixed(1);
            document.getElementById('savePercent').innerText = saved > 0 ? `${saved}%` : '0% (ä¼¼ä¹å·²ç»å¾ˆå°äº†)';

            document.getElementById('downloadBtn').onclick = () => {
                const url = URL.createObjectURL(compressedPdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `compressed_${originalFile.name}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
        }
    </script>
</body>
</html>
