<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»å…¸æ–—å…½æ£‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { touch-action: manipulation; user-select: none; }
        /* æ£‹ç›˜æ ¼å­å¸ƒå±€ */
        .board-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 2px;
            background-color: #5D4037; /* è¾¹æ¡†è‰² */
            border: 4px solid #5D4037;
            width: 100%;
            max-width: 450px;
            aspect-ratio: 7/9;
        }
        .cell {
            background-color: #DEB887; /* åœŸåœ°é¢œè‰² */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            position: relative;
            cursor: pointer;
        }
        /* åœ°å½¢æ ·å¼ */
        .river { background-color: #4FC3F7; }
        .trap { background-color: #D7CCC8; border: 1px dashed #8D6E63; }
        .den { background-color: #FFECB3; font-weight: bold; font-size: 0.8rem; color: #5D4037; }
        
        /* æ£‹å­æ ·å¼ */
        .piece {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10;
            transition: transform 0.2s;
        }
        .piece.red { background: linear-gradient(135deg, #FFEBEE, #FFCDD2); border: 2px solid #D32F2F; color: #B71C1C; }
        .piece.blue { background: linear-gradient(135deg, #E3F2FD, #BBDEFB); border: 2px solid #1976D2; color: #0D47A1; }
        
        .selected { transform: scale(1.15); box-shadow: 0 0 15px yellow; z-index: 20; }
        .valid-move::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: rgba(0, 255, 0, 0.6);
            border-radius: 50%;
            z-index: 5;
        }
        .last-move { background-color: rgba(255, 255, 0, 0.3) !important; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div class="flex flex-col items-center w-full max-w-lg gap-4">
        
        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <div class="flex justify-between w-full items-center bg-white p-3 rounded-xl shadow-sm">
            <div class="flex items-center gap-2">
                <span class="w-4 h-4 rounded-full bg-red-600"></span>
                <span class="font-bold text-slate-700">ç©å®¶ (çº¢)</span>
            </div>
            <div id="status" class="text-sm font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded">
                è½®åˆ°ç©å®¶èµ°æ£‹
            </div>
            <div class="flex items-center gap-2">
                <span class="font-bold text-slate-500">ç”µè„‘ (è“)</span>
                <span class="w-4 h-4 rounded-full bg-blue-600"></span>
            </div>
        </div>

        <!-- æ£‹ç›˜ -->
        <div id="board" class="board-grid rounded shadow-2xl">
            <!-- JS ç”Ÿæˆæ ¼å­ -->
        </div>

        <!-- åº•éƒ¨æ§åˆ¶ -->
        <div class="flex gap-4 w-full">
            <button onclick="initGame()" class="flex-1 bg-white hover:bg-slate-50 text-slate-700 font-bold py-3 rounded-xl shadow transition">
                â™»ï¸ é‡æ–°å¼€å§‹
            </button>
            <div class="bg-white p-3 rounded-xl shadow text-xs text-slate-500 flex-1">
                è§„åˆ™æç¤ºï¼š<br>
                ğŸ˜>ğŸ¦>ğŸ¯>ğŸ†>ğŸº>ğŸ•>ğŸˆ>ğŸ€<br>
                âš ï¸ å”¯ä¸€ç‰¹ä¾‹ï¼šğŸ€ å¯ä»¥åƒ ğŸ˜
            </div>
        </div>

    </div>

    <script>
        // --- æ¸¸æˆé…ç½® ---
        const ROW = 9;
        const COL = 7;
        const RED = 1;  // ç©å®¶
        const BLUE = -1; // ç”µè„‘
        
        // æ£‹å­å®šä¹‰ (ç­‰çº§ 8-1)
        const PIECES = {
            8: { name: 'ğŸ˜', rank: 8 },
            7: { name: 'ğŸ¦', rank: 7 },
            6: { name: 'ğŸ¯', rank: 6 },
            5: { name: 'ğŸ†', rank: 5 },
            4: { name: 'ğŸº', rank: 4 },
            3: { name: 'ğŸ•', rank: 3 },
            2: { name: 'ğŸˆ', rank: 2 },
            1: { name: 'ğŸ€', rank: 1 }
        };

        // åœ°å½¢å®šä¹‰
        // 0:ç©ºåœ°, 1:æ²³, 2:çº¢é™·é˜±, 3:è“é™·é˜±, 4:çº¢ç©´, 5:è“ç©´
        const MAP = [
            [0, 2, 5, 2, 0, 0, 0], // 0 (è“æ–¹è€å®¶)
            [0, 0, 2, 0, 0, 0, 0], // 1
            [0, 0, 0, 0, 0, 0, 0], // 2
            [0, 1, 1, 0, 1, 1, 0], // 3 (æ²³)
            [0, 1, 1, 0, 1, 1, 0], // 4 (æ²³)
            [0, 1, 1, 0, 1, 1, 0], // 5 (æ²³)
            [0, 0, 0, 0, 0, 0, 0], // 6
            [0, 0, 3, 0, 0, 0, 0], // 7
            [0, 0, 0, 3, 4, 3, 0]  // 8 (çº¢æ–¹è€å®¶)
        ];

        // åˆå§‹å¸ƒå±€
        const INIT_LAYOUT = [
            {r:0, c:0, rank:7, team:BLUE}, {r:0, c:6, rank:6, team:BLUE},
            {r:1, c:1, rank:3, team:BLUE}, {r:1, c:5, rank:2, team:BLUE},
            {r:2, c:0, rank:1, team:BLUE}, {r:2, c:2, rank:5, team:BLUE}, {r:2, c:4, rank:4, team:BLUE}, {r:2, c:6, rank:8, team:BLUE},
            
            {r:8, c:6, rank:7, team:RED}, {r:8, c:0, rank:6, team:RED},
            {r:7, c:5, rank:3, team:RED}, {r:7, c:1, rank:2, team:RED},
            {r:6, c:6, rank:1, team:RED}, {r:6, c:4, rank:5, team:RED}, {r:6, c:2, rank:4, team:RED}, {r:6, c:0, rank:8, team:RED}
        ];

        let boardState = []; // å­˜å‚¨æ£‹å­
        let turn = RED;
        let selectedPiece = null; // å½“å‰é€‰ä¸­çš„æ£‹å­ {r, c}
        let gameOver = false;
        let lastMove = null; // è®°å½•æœ€åä¸€æ­¥é«˜äº®

        const boardEl = document.getElementById('board');
        const statusEl = document.getElementById('status');

        function initGame() {
            // åˆå§‹åŒ–ç©ºæ£‹ç›˜
            boardState = Array(ROW).fill(null).map(() => Array(COL).fill(null));
            
            // æ”¾ç½®æ£‹å­
            INIT_LAYOUT.forEach(p => {
                boardState[p.r][p.c] = { rank: p.rank, team: p.team };
            });

            turn = RED;
            gameOver = false;
            selectedPiece = null;
            lastMove = null;
            renderBoard();
            statusEl.innerText = "è½®åˆ°ç©å®¶ (çº¢æ–¹) èµ°æ£‹";
        }

        // æ¸²æŸ“æ£‹ç›˜
        function renderBoard() {
            boardEl.innerHTML = '';
            
            for(let r=0; r<ROW; r++) {
                for(let c=0; c<COL; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    // è®¾ç½®åœ°å½¢æ ·å¼
                    const terrain = MAP[r][c];
                    if(terrain === 1) cell.classList.add('river');
                    if(terrain === 2 || terrain === 3) cell.classList.add('trap');
                    if(terrain === 4) { cell.classList.add('den'); cell.innerText = "ç©´"; }
                    if(terrain === 5) { cell.classList.add('den'); cell.innerText = "ç©´"; }

                    // é«˜äº®æœ€åä¸€æ­¥
                    if(lastMove && ( (lastMove.from.r === r && lastMove.from.c === c) || (lastMove.to.r === r && lastMove.to.c === c) )) {
                        cell.classList.add('last-move');
                    }

                    // æ”¾ç½®æ£‹å­
                    const piece = boardState[r][c];
                    if(piece) {
                        const pDiv = document.createElement('div');
                        pDiv.className = `piece ${piece.team === RED ? 'red' : 'blue'}`;
                        pDiv.innerText = PIECES[piece.rank].name;
                        
                        // é€‰ä¸­é«˜äº®
                        if(selectedPiece && selectedPiece.r === r && selectedPiece.c === c) {
                            pDiv.classList.add('selected');
                        }
                        cell.appendChild(pDiv);
                    }

                    // ç»‘å®šç‚¹å‡»
                    cell.onclick = () => handleCellClick(r, c);
                    
                    // æ˜¾ç¤ºå¯èµ°æç¤º
                    if(selectedPiece && isValidMove(selectedPiece.r, selectedPiece.c, r, c)) {
                        cell.classList.add('valid-move');
                    }

                    boardEl.appendChild(cell);
                }
            }
        }

        // ç‚¹å‡»é€»è¾‘
        function handleCellClick(r, c) {
            if(gameOver || turn !== RED) return;

            const clickedPiece = boardState[r][c];

            // 1. ç‚¹å‡»è‡ªå·±çš„æ£‹å­ -> é€‰ä¸­
            if(clickedPiece && clickedPiece.team === turn) {
                selectedPiece = {r, c};
                renderBoard();
                return;
            }

            // 2. ç‚¹å‡»ç©ºåœ°æˆ–æ•Œäºº -> å°è¯•ç§»åŠ¨
            if(selectedPiece) {
                if(isValidMove(selectedPiece.r, selectedPiece.c, r, c)) {
                    movePiece(selectedPiece.r, selectedPiece.c, r, c);
                    // è½®åˆ°ç”µè„‘
                    if(!gameOver) {
                        statusEl.innerText = "ç”µè„‘æ€è€ƒä¸­...";
                        setTimeout(aiMove, 500);
                    }
                } else {
                    // å¦‚æœç‚¹åˆ°äº†ä¸èƒ½èµ°çš„åœ°æ–¹ï¼Œå–æ¶ˆé€‰ä¸­
                    selectedPiece = null;
                    renderBoard();
                }
            }
        }

        // æ ¸å¿ƒè§„åˆ™ï¼šåˆ¤æ–­æ˜¯å¦åˆæ³•ç§»åŠ¨
        function isValidMove(r1, c1, r2, c2) {
            const p = boardState[r1][c1];
            if(!p) return false;
            
            const target = boardState[r2][c2];
            const terrain1 = MAP[r1][c1];
            const terrain2 = MAP[r2][c2];

            // ä¸èƒ½åƒè‡ªå·±äºº
            if(target && target.team === p.team) return false;

            // ä¸èƒ½è¿›è‡ªå·±çš„å·¢ç©´
            if(p.team === RED && terrain2 === 4) return false;
            if(p.team === BLUE && terrain2 === 5) return false;

            const dr = Math.abs(r1 - r2);
            const dc = Math.abs(c1 - c2);

            // æ™®é€šç§»åŠ¨ï¼šåªèƒ½èµ°ä¸€æ ¼ (ä¸Šä¸‹å·¦å³)
            if(dr + dc !== 1) {
                // ç‰¹æ®Šï¼šç‹®è™è·³æ²³
                if((p.rank === 7 || p.rank === 6) && terrain1 !== 1) {
                    // å¿…é¡»æ¨ªè·¨æˆ–çºµè·¨æ²³æµ
                    // çºµå‘è·³ (æ²³å®½3)
                    if(dc === 0 && Math.abs(r1 - r2) === 4) {
                        // æ£€æŸ¥ä¸­é—´æœ‰æ²¡æœ‰è€é¼ 
                        let hasRat = false;
                        for(let i=1; i<4; i++) {
                            const mr = Math.min(r1, r2) + i;
                            const mp = boardState[mr][c1];
                            if(mp) hasRat = true;
                        }
                        // ç›®æ ‡å¿…é¡»æ˜¯å²¸è¾¹
                        if(!hasRat && (MAP[r1+ (r2-r1)/4][c1] === 1)) return checkEat(p, target, r2, c2);
                    }
                    // æ¨ªå‘è·³ (æ²³å®½2)
                    if(dr === 0 && Math.abs(c1 - c2) === 3) {
                         let hasRat = false;
                        for(let i=1; i<3; i++) {
                            const mc = Math.min(c1, c2) + i;
                            const mp = boardState[r1][mc];
                            if(mp) hasRat = true;
                        }
                        if(!hasRat && (MAP[r1][c1 + (c2-c1)/3] === 1)) return checkEat(p, target, r2, c2);
                    }
                }
                return false;
            }

            // è€é¼ è¿›æ²³
            if(terrain2 === 1 && p.rank !== 1) return false; // åªæœ‰è€é¼ èƒ½è¿›æ²³

            // è€é¼ åœ¨æ²³é‡Œä¸èƒ½åƒå²¸ä¸Šçš„
            if(terrain1 === 1 && terrain2 !== 1 && target) return false;
            
            // è€é¼ åœ¨å²¸ä¸Šä¸èƒ½åƒæ²³é‡Œçš„ (é™¤éç›®æ ‡ä¹Ÿæ˜¯è€é¼ )
            if(terrain1 !== 1 && terrain2 === 1 && target) return false;

            return checkEat(p, target, r2, c2);
        }

        // åƒå­è§„åˆ™åˆ¤æ–­
        function checkEat(attacker, defender, r2, c2) {
            if(!defender) return true; // ç›®æ ‡ä¸ºç©ºï¼Œç›´æ¥èµ°

            // é™·é˜±è§„åˆ™ï¼šæ•Œäººåœ¨æˆ‘çš„é™·é˜±é‡Œï¼Œæ­¤æ—¶é˜²å¾¡åŠ›ä¸º0ï¼Œè°éƒ½èƒ½åƒ
            const inTrap = (defender.team === RED && MAP[r2][c2] === 3) || 
                           (defender.team === BLUE && MAP[r2][c2] === 2);
            if(inTrap) return true;

            // ç‰¹ä¾‹ï¼šè€é¼ åƒå¤§è±¡
            if(attacker.rank === 1 && defender.rank === 8) return true;
            // ç‰¹ä¾‹ï¼šå¤§è±¡ä¸èƒ½åƒè€é¼ 
            if(attacker.rank === 8 && defender.rank === 1) return false;

            // æ­£å¸¸ï¼šå¤§åƒå°
            return attacker.rank >= defender.rank;
        }

        function movePiece(r1, c1, r2, c2) {
            const p = boardState[r1][c1];
            const dead = boardState[r2][c2];
            
            // ç§»åŠ¨
            boardState[r2][c2] = p;
            boardState[r1][c1] = null;
            
            lastMove = { from: {r:r1, c:c1}, to: {r:r2, c:c2} };
            selectedPiece = null;

            // åˆ¤æ–­èƒœåˆ©
            // 1. è¿›äº†å¯¹æ–¹å·¢ç©´
            if(p.team === RED && MAP[r2][c2] === 5) endGame(RED);
            else if(p.team === BLUE && MAP[r2][c2] === 4) endGame(BLUE);
            // 2. å¯¹æ–¹æ— å­å¯èµ° (ç®€åŒ–ä¸ºè¢«åƒå…‰)
            else if(dead) {
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ£‹å­
                let redCnt = 0, blueCnt = 0;
                boardState.flat().forEach(px => {
                    if(px) px.team === RED ? redCnt++ : blueCnt++;
                });
                if(redCnt === 0) endGame(BLUE);
                if(blueCnt === 0) endGame(RED);
            }

            if(!gameOver) {
                turn = turn === RED ? BLUE : RED;
                renderBoard();
                if(turn === RED) statusEl.innerText = "è½®åˆ°ç©å®¶ (çº¢æ–¹)";
                else statusEl.innerText = "ç”µè„‘ (è“æ–¹) æ­£åœ¨æ€è€ƒ...";
            }
        }

        function endGame(winner) {
            gameOver = true;
            renderBoard();
            if(winner === RED) statusEl.innerText = "ğŸ‰ æ­å–œï¼ç©å®¶è·èƒœï¼";
            else statusEl.innerText = "ğŸ’€ ç”µè„‘è·èƒœï¼Œå†æ¥å†å‰ï¼";
        }

        // --- ç®€å• AI ---
        function aiMove() {
            if(gameOver) return;
            
            let allMoves = [];
            // 1. éå†æ‰€æœ‰è“æ–¹æ£‹å­
            for(let r=0; r<ROW; r++) {
                for(let c=0; c<COL; c++) {
                    const p = boardState[r][c];
                    if(p && p.team === BLUE) {
                        // 2. å°è¯•ä¸Šä¸‹å·¦å³ç§»åŠ¨
                        const dirs = [[0,1], [0,-1], [1,0], [-1,0]]; // åŸºç¡€ç§»åŠ¨
                        // åŠ ä¸Šç‹®è™è·³æ²³çš„æ£€æµ‹ç‚¹ (ç®€åŒ–ç‰ˆï¼Œç›´æ¥éå†å…¨å›¾åˆ¤æ–­åˆæ³•æ€§)
                        // ä¸ºäº†æ€§èƒ½ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•ç‚¹ï¼Œåªæ£€æµ‹å‘¨å›´å’Œè·³è·ƒ
                        
                        // æš´åŠ›æ‰«æå…¨å›¾å¯èƒ½çš„ç›®æ ‡ç‚¹ (å¯¹äº7x9ä¸å¤§)
                        for(let tr=0; tr<ROW; tr++) {
                            for(let tc=0; tc<COL; tc++) {
                                if(isValidMove(r, c, tr, tc)) {
                                    allMoves.push({ from: {r,c}, to: {tr,tc}, score: 0 });
                                }
                            }
                        }
                    }
                }
            }

            if(allMoves.length === 0) {
                endGame(RED);
                return;
            }

            // 3. è¯„åˆ†ç­–ç•¥
            allMoves.forEach(m => {
                const target = boardState[m.to.tr][m.to.tc];
                // åƒå­å¾—åˆ†
                if(target) {
                    m.score += target.rank * 10;
                    if(target.rank === 8) m.score += 50; // åƒå¤§è±¡åŠ åˆ†
                }
                
                // è¿›æ”»å¾—åˆ† (è·ç¦»çº¢æ–¹å…½ç©´è¶Šè¿‘åˆ†è¶Šé«˜)
                // çº¢æ–¹å…½ç©´åœ¨ (8, 3) é™„è¿‘
                const distToDen = Math.abs(m.to.tr - 8) + Math.abs(m.to.tc - 3);
                m.score -= distToDen; // è·ç¦»è¶Šå°åˆ†è¶Šé«˜ (è´Ÿæ•°ç»å¯¹å€¼å°)

                // è¿›è€çªç›´æ¥èµ¢
                if(MAP[m.to.tr][m.to.tc] === 4) m.score += 1000;

                // éšæœºæ‰°åŠ¨ï¼Œé¿å…æ­»æ¿
                m.score += Math.random() * 2;
            });

            // 4. æ’åºå–æœ€å¥½
            allMoves.sort((a, b) => b.score - a.score);
            
            // 5. æ‰§è¡Œ
            // ç¨å¾®æœ‰ç‚¹æ¦‚ç‡é€‰ç¬¬äºŒå¥½çš„ï¼Œé˜²æ­¢æ­»å¾ªç¯ (90%é€‰æœ€å¥½çš„)
            const pick = (allMoves.length > 1 && Math.random() > 0.9) ? allMoves[1] : allMoves[0];
            
            movePiece(pick.from.r, pick.from.c, pick.to.tr, pick.to.tc);
        }

        initGame();

    </script>
</body>
</html>
